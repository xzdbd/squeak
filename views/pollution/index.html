<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Lock viewport to prevent scaling -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="description" content="Pullution Minotor - ArcGIS">
  <meta name="author" content="">
  <link rel="icon" href="https://www.esri.com/favicon.ico">
  <title>Pullution Minotor</title>

  <!-- Bootstrap - For testing only -->
  <!--link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"-->

  <!-- Calcite Maps Bootstrap -->
  <link rel="stylesheet" href="static/css/calcite-maps-bootstrap-v0.3.css">

  <!-- Calcite Maps -->
  <link rel="stylesheet" href="static/css/calcite-maps-arcgis-4.x.min-v0.3.css">

   <!-- Calcite Maps Extend -->
  <link rel="stylesheet" href="static/css/calcite-maps-extend.css">
  
  <!-- ArcGIS JS 4.x -->
  <link rel="stylesheet" href="https://xzdbd.com/static/arcgis/js/4.2/esri/css/main.css">
  <!--link rel="stylesheet" href="../../dist/css/arcgis/themes/light/main.css"-->

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #panelLegend .panel-body {
      background-color: white;
    }

    #panelInfo .esri-icon.esri-icon-map-pin {
      margin-right: 10px;
      font-size: 25px;
    }

    #panelInfo .info-title {
      font-size: 20px;
    }

    .form-box {
      display: flex;
      margin: 0px 15px;
      padding: 15px 0;
      border: 1px solid rgba(255,255,255,.35);
      background-color: rgba(130,130,130,.1);
    }

    .btn-color-close {
      margin-top: -17px;
      margin-right: -21px;
      font-size: 14px;
      color: #828282;
    }
    .btn-color-close:hover,
    .btn-color-close:focus {
      color: #000;
    }

    .control-padding-top {
      padding-top: 5px;
    }

    .padding-right-none {
      padding-right: 0;
    }

    .info-title {
      font-size: 25px;
      margin-bottom: 10px;
    }

    /* Color Widget */

    .esri-color-picker .esri-swatch-preview.esri-container,
    .esri-color-picker .esri-header,
    .esri-color-picker .esri-footer,
    .esri-color-picker .esri-palette-options .esri-palette-toggle > input,
    .dijitReset .dijitToggleButtonIconChar,
    .esri-color-picker .esri-palette-options .esri-palette-toggle {
      display: none;
    }
    .esri-color-picker.esri-container {
      border: 0;
      padding: 0;
      border-radius: 0;
      background-color: transparent;
    }
    .esri-color-picker .esri-hex-input {
      border: 0;
      width: 100%;
    }
    .esri-color-picker .esri-swatch-row {
      line-height: 1;
    }
    .esri-color-picker .esri-swatch {
      width: 13px;
      height: 13px;
    }
    .esri-color-picker .esri-hex-input .dijitInputInner {
      font-size: 12px;
      width: 100%;
      padding: 2px 4px;
    }

  </style>

</head>

<body class="calcite-nav-top">

  <!-- Navbar -->

  <nav class="navbar navbar-fixed-top calcite-navbar calcite-bgcolor-dark calcite-text-light">
     <!-- Menu -->
    <div class="dropdown calcite-dropdown calcite-bg-light calcite-text-dark" role="presentation">
      <!--a class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"-->
      <a class="dropdown-toggle" role="button" aria-haspopup="true" aria-expanded="false">
        <div class="calcite-dropdown-toggle">
          <span class="sr-only">Toggle dropdown menu</span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>
      </a>
      <ul class="dropdown-menu">
        <li><a role="button" data-target="#modalSplash" data-toggle="modal" aria-haspopup="true"> About</a></li>
        <li><a class="hidden-md hidden-lg" href="#2dTab" aria-controls="2Dtab" role="tab" data-toggle="tab"> Map</a></li>
        <li><a role="button" data-target="#panelInfo" aria-haspopup="true"><span class="glyphicon glyphicon-info-sign"></span> Info</a></li>
        <li><a class="visible-xs" role="button" data-target="#panelSearch" aria-haspopup="true"><span class="glyphicon glyphicon-search"></span> Search</a></li>
        <li><a role="button" data-target="#panelBasemaps" aria-haspopup="true"><span class="glyphicon glyphicon-th-large"></span> Basemaps</a></li>
        <li><a role="button" data-target="#panelBookmarks" aria-haspopup="true"><span class="glyphicon glyphicon-book"></span> Bookmarks</a></li>
        <li><a role="button" data-target="#panelQuery" aria-haspopup="true"><span class="glyphicon glyphicon-map-marker"></span> Query</a></li>
        <li><a role="button" data-target="#panelSqueakQuery" aria-haspopup="true"><span class="glyphicon glyphicon-map-marker"></span> Squeak Query</a></li>
        <li><a role="button" data-target="#panelSqueakLengend" aria-haspopup="true"><span class="glyphicon glyphicon-list"></span> Squeak Query</a></li>
        <li><a role="button" data-target="#panelLegend" aria-haspopup="true"><span class="glyphicon glyphicon-list"></span> Legend</a></li>
        <li><a role="button" id="calciteToggleNavbar" aria-haspopup="true"><span class="glyphicon glyphicon-fullscreen"></span> Full Map</a></li>
      </ul>
    </div> 
    <!-- Title -->
    <div class="calcite-title calcite-overflow-hidden">
      <span class="calcite-title-main">Pollution Monitor System</span>
      <span class="calcite-title-divider hidden-xs"></span>
      <span class="calcite-title-sub hidden-xs">Hangzhou</span> 
    </div>
    <!-- Nav -->
    <ul class="calcite-nav nav navbar-nav">                    
      <li class="active"><a id="mapNav" class="hidden-xs hidden-sm" href="#2dTab" aria-controls="2Dtab" aria-expanded="true" role="tab" data-toggle="tab" data-tooltip="tip" title="2D View" data-placement="bottom">Map</a></li>                 
      <li><div class="calcite-navbar-search calcite-search-expander"><div id="searchNavDiv"></div></div></li>
    </ul>
  </nav><!--/.navbar -->

  <!-- Modal Window -->

  <div class="modal fade" id="modalSplash" tabindex="-1" role="dialog" aria-labelledby="splashlModal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <div class="container-fluid">
            <div class="row">
              <div class="splash-body">
                <div class="text-center">
                  <h3>Welcome to Water Distribution System</h3>
                  <hr>
                  <div class="form-inline">
                    <div class="form-group">
                      <button type="button" class="btn btn-success btn-lg"  data-dismiss="modal">Get started</a>
                    </div>
                  </div>
                  <br>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Map Container  -->

  <div class="calcite-map calcite-map-absolute">
    <div id="tabContainer" class="tab-content">
      <div id="2dTab" class="tab-pane fade in active" role="tabpanel">
        <div id="mapViewDiv"></div>
      </div>
    </div>
  </div>

  <!-- Toggle Content Panel  -->
  <div class="calcite-div-toggle calcite-div-toggle-bottom">
    <div class="calcite-div-toggle-background">
      <div class="up-and-down-arrow" title="Hide Panel"></div>
      <div class="span-result" title="result">结果</div>
    </div>
  </div>

  <!-- Bottom Content Panel  -->

  <div class="calcite-div-content calcite-div-content-bottom">
    <div class="calcite-div-content-transparent-background calcite-div-content-info">
      <div class="calcite-div-content-resultbox-panel">
        <div class="calcite-div-content-box-container" id="resultContentContainer">
          <div class="calcite-div-content-info-container">
            <div class="calcite-div-content-header-container">
              <p>content1</p>
            </div>
          </div> 
        </div>

        <div class="calcite-div-content-box-container" id="result2ContentContainer">
          <div class="calcite-div-content-info-container">
            <div class="calcite-div-content-header-container">
              <p>content2</p>
            </div>
          </div> 
        </div>

        <div class="calcite-div-content-box-container" id="result3ContentContainer">
          <div class="calcite-div-content-info-container">
            <div class="calcite-div-content-header-container">
              <p>content3</p>
            </div>
          </div> 
        </div>

        <div class="calcite-div-content-box-container" id="result4ContentContainer">
          <div class="calcite-div-content-info-container">
            <div class="calcite-div-content-header-container">
              <p>content4</p>
            </div>
          </div> 
        </div>

        <div class="calcite-div-content-box-container" id="result5ContentContainer">
          <div class="calcite-div-content-info-container">
            <div class="calcite-div-content-header-container">
              <p>content5</p>
            </div>
          </div> 
        </div>

      </div>
    </div>   
  </div>

  

  <!-- Panel Container -->
  
  <div class="calcite-panels calcite-panels-right calcite-bgcolor-light-orange calcite-text-dark panel-group" role="tablist" aria-multiselectable="true">
    
    <!-- Panel - Info -->

    <div id="panelInfo" class="panel collapse">
      <div id="headingInfo" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseInfo" aria-expanded="true" aria-controls="collapseInfo"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span><span class="panel-label">Info</span></a> 
          <a class="panel-close" role="button" data-toggle="collapse" data-target="#panelInfo"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>  
        </div>
      </div>
      <div id="collapseInfo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingInfo">
        <div class="panel-body">
          <p><span class="esri-icon esri-icon-map-pin pull-left"></span><span class="info-title">Calcite Maps</span></p>
        </div>
      </div>
    </div>
    
    <!-- Panel - Search -->

    <div id="panelSearch" class="panel collapse hidden-sm hidden-md hidden-lg">
      <div id="headingSearch" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle collapsed" role="button" data-toggle="collapse" href="#collapseSearch" aria-expanded="false" aria-controls="collapseSearch"><span class="glyphicon glyphicon-search" aria-hidden="true"></span><span class="panel-label">Search</span></a> 
          <a class="panel-close" role="button" data-toggle="collapse" data-target="#panelSearch"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>        
        </div>
      </div>
      <div id="collapseSearch" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingSearch">
        <div class="panel-body calcite-body-expander"> 
          <div id="searchPanelDiv"></div>
        </div>
      </div>
    </div>

    <!-- Panel - Basemaps -->

     <div id="panelBasemaps" class="panel collapse">
      <div id="headingBasemaps" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseBasemaps" aria-expanded="false" aria-controls="collapseBasemaps"><span class="glyphicon glyphicon-th-large" aria-hidden="true"></span><span class="panel-label">Basemaps</span></a> 
          <a class="panel-close" role="button" data-toggle="collapse" data-target="#panelBasemaps"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>  
        </div>
      </div>
      <div id="collapseBasemaps" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingBasemaps">
        <div class="panel-body">
          <select id="selectBasemapPanel" class="form-control"> 
            <option value="streets" data-vector="streets-vector">Streets</option>
            <option value="satellite" data-vector="satellite">Satellite</option>
            <option value="hybrid" data-vector="hybrid">Hybrid</option>
            <option value="national-geographic" data-vector="national-geographic">National Geographic</option>
            <option value="topo" data-vector="topo">Topographic</option>
            <option value="gray" data-vector="gray-vector" selected>Gray</option>
            <option value="dark-gray" data-vector="dark-gray-vector">Dark Gray</option>
            <option value="osm" data-vector="osm">Open Street Map</option>
            <option value="dark-gray" data-vector="streets-night-vector">Streets Night</option>
            <option value="streets" data-vector="streets-navigation-vector">Streets Navigation</option>
          </select>
        </div>
      </div>

    </div>

    <!-- Panel - Bookmarks -->

    <div id="panelBookmarks" class="panel collapse">
      <div id="headingBookmarks" class="panel-heading" role="tab">
        <div class="panel-title">
        <a class="panel-toggle collapsed" role="button" data-toggle="collapse" href="#collapseBookmarks" aria-expanded="false" aria-controls="collapseBookmarks"><span class="glyphicon glyphicon-book" aria-hidden="true"></span><span class="panel-label">Bookmarks</span></a> 
        <a class="panel-close" role="button" data-toggle="collapse" data-target="#panelBookmarks"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>  
        </div>
      </div>
      <div id="collapseBookmarks" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingBookmarks">
        <div class="panel-body">          
        <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
          <ol class="carousel-indicators">
            <li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
            <li data-target="#carousel-example-generic" data-slide-to="1"></li>
            <li data-target="#carousel-example-generic" data-slide-to="2"></li>
          </ol>
          <div class="carousel-inner" role="listbox">
            <div class="item active">
              <img src="http://nextday-pic.b0.upaiyun.com/20130401/big-568h@2x.jpg!jpg85" alt="...">
              <div class="carousel-caption">
              <!-- Your caption goes here -->
              </div>
            </div>
            <div class="item">
              <img src="http://nextday-pic.b0.upaiyun.com/20130401/big-568h@2x.jpg!jpg85" alt="...">
              <div class="carousel-caption">
              <!-- Your caption goes here -->
              </div>
            </div>
            <div class="item">
              <img src="http://nextday-pic.b0.upaiyun.com/20130401/big-568h@2x.jpg!jpg85" alt="...">
              <div class="carousel-caption">
              <!-- Your caption goes here -->                            
              </div>
            </div>
          </div>
          <a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
          <span class="ntglyphicon glyphicon-chevron-left" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
          </a>
          <a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
          <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
          </a>
        </div>
        </div>
      </div>
    </div>

    <!-- Panel - Query -->

    <div id="panelQuery" class="panel collapse">
      <div id="headingQuery" class="panel-heading" role="tab">
        <div class="panel-title">
        <a class="panel-toggle collapsed" role="button" data-toggle="collapse" href="#collapseQuery" aria-expanded="false" aria-controls="collapseQuery"><span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span><span class="panel-label">Query</span></a> 
        <a class="panel-close" role="button" data-toggle="collapse" data-target="#panelQuery"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>  
        </div>
      </div>
      <div id="collapseQuery" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingQuery">
        <div class="panel-body">          
          <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#bus" aria-controls="bus" role="tab" data-toggle="tab">Bus</a></li>
            <li role="presentation"><a href="#bus2" aria-controls="bus2" role="tab" data-toggle="tab">Bus2</a></li>
            <li role="presentation"><a href="#bus3" aria-controls="bus3" role="tab" data-toggle="tab">Bus3</a></li>
            <li role="presentation"><a href="#bus4" aria-controls="bus4" role="tab" data-toggle="tab">Bus4</a></li>
          </ul>

        <div class="tab-content">

            <!-- Tab -Bus1 -->
          
            <div role="tabpanel" class="tab-pane active" id="bus">  
              <div class="calcite-form-title">Bus Information</div>  
              <div class="form-horizontal calcite-form-padding">
                <div class="form-group">
                  <label for="queryBusIDInput" class="col-xs-3 control-label">ID</label>
                  <div class="col-xs-9">
                    <input type="text" class="form-control" id="queryBusIDInput" readonly="true" placeholder="{ID}">
                  </div>
                </div>
                <div class="form-group">
                  <label for="settingsSubTitleInput" class="col-xs-3 control-label">Name</label>
                  <div class="col-xs-9">
                    <input type="text" class="form-control" id="queryBusNameInput" readonly="true" placeholder="{Name}">
                  </div>
                </div>
                <div class="form-group">
                  <div class="col-xs-9 col-xs-offset-3">
                    <button id="titleButton" type="button" class="btn btn-primary btn-block">Apply</button>
                  </div>
                </div>

              </div>
            </div>

            <!-- Tab -Bus2 -->
          
            <div role="tabpanel" class="tab-pane" id="bus2">  
              <div class="calcite-form-title">Bus Information</div>  
              <div class="form-horizontal calcite-form-padding">
                <table id="bus2-info-table" class="table table-responsive">
                  <tr>
                    <th><input type="checkbox"/></th>
                    <th>ID</th>
                    <th>Name</th>
                  </tr>
                  <tr>
                    <td><input type="checkbox"/></td>
                    <td>January</td>
                    <td>$100</td>
                  </tr>
                </table>
              </div>
            </div>

            <!-- Tab -Bus3 -->
          
            <div role="tabpanel" class="tab-pane" id="bus3">  
              <div class="calcite-form-title">Bus Information</div>  
              <div class="form-horizontal calcite-form-padding" id="bus3-div">
                <table id="bus3-info-table" class="table table-responsive">
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                  </tr>
                  <tr>
                    <td>January</td>
                    <td>$100</td>
                  </tr>
                </table>
              </div>
            </div>

            <!-- Tab -Bus4 -->
          
            <div role="tabpanel" class="tab-pane" id="bus4">  
              <div class="calcite-form-title">Bus Information</div>  
              <div class="form-horizontal calcite-form-padding">
                <table id="bus4-info-table" class="table table-responsive">
                  <tr>
                    <th><input type="checkbox"/></th>
                    <th>ID</th>
                    <th>Name</th>
                  </tr>
                  <tr class="active">
                    <td><input type="checkbox"/></td>
                    <td>January</td>
                    <td>$100</td>
                  </tr>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>


    <!-- Panel - Squeak Query -->

    <div id="panelSqueakQuery" class="panel collapse">
      <div id="headingSqueakQuery" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle collapsed" role="button" data-toggle="collapse" href="#collapseSqueakQuery" aria-expanded="false" aria-controls="collapseSqueakQuery"><span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span><span class="panel-label">Squeak Query</span></a> 
          <a class="panel-close" role="button" data-toggle="collapse" data-target="#panelSqueakQuery"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a> 
        </div>
      </div>
      <div id="collapseSqueakQuery" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingSqueakQuery">
        <div class="panel-body">            
          <div id="squeakQueryDiv">
            <div class="calcite-form-title">Bus Information</div>  
              <div class="form-horizontal calcite-form-padding" id="bus3-div">
                <table id="bus-info-table" class="table table-responsive">
                </table>
              </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel - Legend -->

    <div id="panelLegend" class="panel collapse">
      <div id="headingLegend" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle collapsed" role="button" data-toggle="collapse" href="#collapseLegend" aria-expanded="false" aria-controls="collapseLegend"><span class="glyphicon glyphicon-list" aria-hidden="true"></span><span class="panel-label">Legend</span></a> 
          <a class="panel-close" role="button" data-toggle="collapse" data-target="#panelLegend"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a> 
        </div>
      </div>
      <div id="collapseLegend" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingLegend">
        <div class="panel-body">            
          <div id="legendDiv"></div>
        </div>
      </div>
    </div>

   
  </div> <!-- /.calcite-panels group-->

  <script type="text/javascript">
    var dojoConfig = {
      packages: [{
        name: "bootstrap",
        location: location.pathname.replace(/\/[^/]+$/, "") + "/static/vendor/dojo-bootstrap"
      },
      {
        name: "calcite-maps",
        location: location.pathname.replace(/\/[^/]+$/, "") + "/static/js/dojo"
        //location: location.pathname.replace(/\/[^/]+$/, "") + "./../../lib/js/dojo"
      },
      {
        name: "calcite-settings",
        location: location.pathname.replace(/\/[^/]+$/, "") + "/static/js"
      },
      {
        name: "squeak",
        location: location.pathname.replace(/\/[^/]+$/, "") + "/static/js/squeak"
      }
      ]
    };
  </script>

  <!-- ArcGIS JS 4.x -->
  <script src="https://xzdbd.com/static/arcgis/js/4.2/init.js"></script>
  <script src="static/js/query.js"></script>

  <script>
    
    var app;

    require([
      // ArcGIS
      "esri/Map",
      "esri/Basemap",
      "esri/layers/VectorTileLayer",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/widgets/Search",
      "esri/widgets/Popup",
      "esri/widgets/Home",
      "esri/widgets/Legend",
      "esri/widgets/ColorPicker",
      "esri/core/watchUtils",
      "esri/layers/FeatureLayer",
      "esri/layers/MapImageLayer",
      "dojo/query",
      "dojo/dom-class",
      "dojo/dom",
      "dojo/on",

      // Calcite Maps
      "calcite-maps/calcitemaps-v0.3",
      //"calcite-maps/calcitemaps",
      "calcite-settings/panelsettings",

      // Boostrap
      "bootstrap/Collapse", 
      "bootstrap/Dropdown",
      "bootstrap/Tab",
      "bootstrap/Carousel",
      "bootstrap/Tooltip",
      "bootstrap/Modal",

      // Dojo
      "dojo/domReady!"
    ], function(Map, Basemap, VectorTileLayer, MapView, SceneView, Search, Popup, Home, Legend, ColorPicker, 
      watchUtils, FeatureLayer, MapImageLayer, query, domClass, dom, on, CalciteMapsSettings, PanelSettings) {
      
      app = {
        scale: 1155581,
        lonlat: [119.98970031737869,29.75321096797822],
        mapView: null, 
        mapDiv: "mapViewDiv",
        mapFL: null,
        vectorLayer: null,
        sceneView: null, 
        sceneDiv: "sceneViewDiv",
        sceneFL: null,
        activeView: null,
        searchWidgetNav: null, 
        searchWidgetPanel: null, 
        searchWidgetSettings: null,
        basemapSelected: "gray",
        basemapSelectedAlt: "gray",
        padding: { 
          top: 85 ,
          right: 0,
          bottom: 0,
          left: 0
        }, 
        uiPadding: { 
          components:["zoom", "attribution", "home", "compass"],
          padding: {
            top: 15,
            right: 15,
            bottom: 30,
            left: 15
          }
        },
        popupOptions: {
          autoPanEnabled: true,
          messageEnabled: false,
          spinnerEnabled: false,
          dockEnabled: true,
          dockOptions: {
            buttonEnabled: true,
            breakpoint: 544 // default
          }
        },
        colorPickerWidget: null,
        panelSettings: null
      }

      //----------------------------------
      // App
      //----------------------------------

      initializeMapViews();
      initializeAppUI();


      //----------------------------------
      // Map and Scene View
      //----------------------------------

      function initializeMapViews() {
          app.mapView = new MapView({
            container: app.mapDiv,
            map: new Map( {basemap: app.basemapSelected, constraints: { snapToZoom: false } } ),
            scale: app.scale,
            center: app.lonlat, 
            padding: app.padding,
            ui: app.uiPadding, 
            popup: new Popup(app.popupOptions),
            visible: true
          })

          app.activeView = app.mapView;

          app.mapView.then(function() {
            var mapImageLayer = new MapImageLayer({
              url: "https://gis.xzdbd.com/arcgis/rest/services/dev/PollutionStation/MapServer"
            });
            app.mapView.map.add(mapImageLayer);
            
            var template = {
              title: "<font color='#008000'>监测站：{name}",

              content: [{
                type: "fields",
                fieldInfos: [{
                  fieldName: "code", 
                  visible: true,
                  label: "站点编码",
                  format: {
                    places: 0,
                    digitSeparator: true
                  }
                }, {
                  fieldName: "name", 
                  visible: true,
                  label: "站点名称",
                  format: {
                    places: 0,
                    digitSeparator: true
                  }
                }, {
                  fieldName: "area", 
                  visible: true,
                  label: "所在城市",
                  format: {
                    places: 0,
                    digitSeparator: true
                  },       
                  }
                ]
              }, {
                type: "text",
                text: "当前AQI值：{aqi}"
              }]
            };

            var monitorFeatureLayer = new FeatureLayer({
                  url: "https://gis.xzdbd.com/arcgis/rest/services/dev/PollutionStation/MapServer/0",
                  outFields: ["*"],
                  popupTemplate: template
            });
            app.mapView.map.add(monitorFeatureLayer);

            var legend = new Legend({
              view: app.mapView,
              layerInfos: [{
                layer: mapImageLayer,
                title: "图例"
              }],
              visible: false
            });
            app.mapView.ui.add(legend, "bottom-right");

          });
      }

      //----------------------------------
      // App UI Handlers
      //----------------------------------

      function initializeAppUI() {
        // App UI
        setBasemapEvents();
        setSearchWidgets();
        setPopupPanelEvents();
        setPopupEvents();
      }
      
      //----------------------------------
      // Basemaps
      //----------------------------------

      function setBasemapEvents() {

        // Sync basemaps for map and scene
        query("#selectBasemapPanel").on("change", function(e){
          app.basemapSelected = e.target.options[e.target.selectedIndex].dataset.vector;
          setBasemaps();               
        });

        function setBasemaps() {
          app.mapView.map.basemap = app.basemapSelected;
        } 
      }

      //----------------------------------
      // Search Widgets
      //----------------------------------

      function setSearchWidgets() {
        
        //TODO - Search Nav + Panel (detach/attach)
        app.searchWidgetNav = createSearchWidget("searchNavDiv", true);
        app.searchWidgetPanel = createSearchWidget("searchPanelDiv", true);
        app.searchWidgetSettings = createSearchWidget("settingsSearchDiv", false);

         // Create widget
        function createSearchWidget(parentId, showPopup) {
          var search = new Search({
            viewModel: {
              view: app.activeView,
              popupOpenOnSelect: showPopup,
              highlightEnabled: false,
              maxSuggestions: 4
            },
            }, parentId);
          search.startup();
          return search;
        } 
      }

      //----------------------------------
      // Popups and Panels
      //----------------------------------

      function setPopupPanelEvents() {

        // Views - Listen to view size changes to show/hide panels
        app.mapView.watch("size", viewSizeChange);

        function viewSizeChange(screenSize) {
          if (app.screenWidth !== screenSize[0]) {
            app.screenWidth = screenSize[0];
            setPanelVisibility();
          }
        }

        // Popups - Listen to popup changes to show/hide panels
        app.mapView.popup.watch(["visible", "currentDockPosition"], setPanelVisibility);

        // Panels - Show/hide the panel when popup is docked
        function setPanelVisibility() {
           var isMobileScreen = app.activeView.widthBreakpoint === "xsmall" || app.activeView.widthBreakpoint === "small",
            isDockedVisible = app.activeView.popup.visible && app.activeView.popup.currentDockPosition,
            isDockedBottom = app.activeView.popup.currentDockPosition && app.activeView.popup.currentDockPosition.indexOf("bottom") > -1;
          // Mobile (xsmall/small)
          if (isMobileScreen) {
            if (isDockedVisible && isDockedBottom) {
              query(".calcite-panels").addClass("invisible");
            } else {
              query(".calcite-panels").removeClass("invisible");
            }
          } else { // Desktop (medium+)
            if (isDockedVisible) {
              query(".calcite-panels").addClass("invisible");
            } else {
              query(".calcite-panels").removeClass("invisible");          
            }
          }
        }

        // Panels - Dock popup when panels show (desktop or mobile)
        query(".calcite-panels .panel").on("show.bs.collapse", function(e) {
          if (app.activeView.popup.currentDockPosition || app.activeView.widthBreakpoint === "xsmall") {
            app.activeView.popup.dockEnabled = false;
          }
        });

        // Panels - Undock popup when panels hide (mobile only)
        query(".calcite-panels .panel").on("hide.bs.collapse", function(e) {
          if (app.activeView.widthBreakpoint === "xsmall") {
            app.activeView.popup.dockEnabled = true;
          }
        });
      }

      //----------------------------------
      // Popup collapse (optional)
      //----------------------------------

      function setPopupEvents() {      
        query(".esri-popup__header-title").on("click", function(e){
          query(".esri-popup__main-container").toggleClass("esri-popup-collapsed");
          app.activeView.popup.reposition();
        }.bind(this));
      }

    });
  </script>

</body>
</html>

